# AI-Powered Unified Email Assistant

## 1. Overview

This application provides a web-based interface to manage emails from both Gmail and a local Outlook Desktop installation. It features an AI-powered reply drafting assistant that uses a local Ollama instance with Retrieval Augmented Generation (RAG) to emulate your writing style based on your previously sent emails. You can view a combined inbox, draft replies with AI assistance, and send emails directly from the respective platforms.

## 2. Features

* **Unified Inbox:** View emails from both Gmail and local Outlook Desktop in a single interface.
* **Platform Indication:** Clearly see whether an email is from Gmail or Outlook.
* **AI Reply Drafting (RAG):**
    * Click "Draft Reply" on any email to open a modal.
    * The system fetches the original email content.
    * It retrieves examples of your previously sent emails *from the same platform* (Gmail or Outlook) to learn your writing style.
    * A local Ollama LLM generates a draft reply emulating this style and addressing the incoming email.
* **Editable Drafts:** Review and edit the AI-generated draft.
* **Send from Respective Platform:** Send the finalized reply using the original email's platform (Gmail or Outlook Desktop).
* **Local First:** Utilizes your local Ollama instance and local Outlook Desktop application.

## 3. Architecture

The system consists of two main parts:

* **Backend (Python Flask Server - `app.py`):**
    * Handles authentication and communication with the Gmail API.
    * Interacts with the local Microsoft Outlook Desktop application (Windows only) using COM.
    * Interfaces with a local Ollama instance for LLM-based text generation.
    * Implements the RAG logic, including fetching sent items for style examples.
    * Exposes API endpoints for the frontend to fetch emails, get details, draft replies, and send emails.
* **Frontend (Web Interface - HTML, CSS, JavaScript):**
    * Provides the user interface for viewing emails and interacting with the drafting/sending features.
    * Communicates with the Python backend via HTTP requests.
    * Uses Bootstrap for basic styling.

## 4. File Structure (Key Files)

* `app.py`: The main Python Flask backend server application.
* `generate_token_gmail.py`: A utility script to run once for Gmail to authorize the application and create `token_gmail.json`.
* `credentials_gmail.json`: **(You provide this)** Downloaded from Google Cloud Console for Gmail API access (OAuth 2.0 Client ID for Desktop app).
* `token_gmail.json`: **(Generated by `generate_token_gmail.py`)** Stores your Gmail OAuth 2.0 tokens. Keep this file secure.
* `unified_email_ui/` (or your chosen frontend folder name):
    * `index.html`: The main HTML file for the web interface (inbox view).
    * `script.js`: JavaScript logic for the frontend, handling API calls and UI updates.
    * `style.css`: Basic CSS for styling.
* `(Optional Fallback) user_sent_gmail.csv` / `user_sent_outlook.csv`: CSV files that *can* be used as a fallback for RAG style examples if live fetching of sent items fails. The backend primarily tries to fetch live sent items.

## 5. Prerequisites

* **Python:** Version 3.9 or higher recommended.
* **Pip:** Python package installer.
* **Ollama:** Installed and running locally. (Download from [ollama.com](https://ollama.com/))
    * An LLM model downloaded via Ollama (e.g., `ollama pull deepseek-r1:14b`, `ollama pull llama3`).
* **Microsoft Outlook Desktop:** Installed, configured, and running on the same Windows machine where `app.py` will be executed.
* **Google Account:** For Gmail integration.
* **Web Browser:** For accessing the frontend.
* **Windows Operating System:** Required for the Outlook Desktop integration via `win32com`. Gmail functionality can work on other OS if Outlook parts are conditionally disabled.

## 6. Setup and Installation

1.  **Project Files:**
    * Ensure all provided project files (`app.py`, `generate_token_gmail.py`, frontend files in their folder) are in your main project directory.
    * Place your downloaded `credentials_gmail.json` in the main project directory.

2.  **Python Environment:**
    * It's highly recommended to create a virtual environment:
        ```bash
        python -m venv venv
        source venv/bin/activate  # On Linux/macOS
        venv\Scripts\activate    # On Windows
        ```
    * Install required Python dependencies:
        ```bash
        pip install Flask flask-cors google-api-python-client google-auth-httplib2 google-auth-oauthlib pywin32 requests python-dotenv
        ```
        (Note: `python-dotenv` is listed but not actively used in the final version of `app.py` provided; it was for an alternative MS Graph setup. `pywin32` is only needed on Windows for Outlook.)

3.  **Ollama Setup:**
    * Install Ollama from [ollama.com](https://ollama.com/).
    * Start the Ollama application/service.
    * Download your desired LLM model. For example:
        ```bash
        ollama pull deepseek-r1:14b
        ```
    * Verify Ollama is running (usually `http://localhost:11434` should be accessible).
    * Update the `OLLAMA_MODEL` variable in `app.py` if you use a different model name.

4.  **Gmail API Setup & Authentication:**
    * **Google Cloud Project:**
        * If you haven't already, create a project on [Google Cloud Console](https://console.cloud.google.com/).
        * Enable the **Gmail API** for your project.
        * Create an **OAuth 2.0 Client ID**. Choose **"Desktop app"** as the application type.
        * Download the JSON credentials file. Rename it to `credentials_gmail.json` and place it in your main project directory (where `app.py` is).
    * **Generate Gmail Token (`token_gmail.json`):**
        * Open your terminal in the project directory (with your virtual environment activated).
        * Run the token generation script:
            ```bash
            python generate_token_gmail.py
            ```
        * This will open a browser window, asking you to log in to your Google account and grant permissions. **Ensure you grant all requested permissions** (related to reading, sending, and metadata for emails, as defined in `GMAIL_SCOPES` in the scripts).
        * After successful authorization, a `token_gmail.json` file will be created in your project directory. This file stores your access and refresh tokens. **Keep this file secure.**
        * The `GMAIL_SCOPES` in `app.py` and `generate_token_gmail.py` should include:
            * `https://www.googleapis.com/auth/gmail.readonly`
            * `https://www.googleapis.com/auth/gmail.send`
            * `https://www.googleapis.com/auth/gmail.metadata`

5.  **Outlook Desktop Setup:**
    * Ensure Microsoft Outlook Desktop is installed, configured with your email account(s), and **running** on the Windows machine where you intend to run `app.py`.
    * The backend (`app.py`) will automatically attempt to connect to the running Outlook instance.

6.  **(Optional) RAG Style Examples CSVs:**
    * The system primarily tries to fetch your recent sent items live from Gmail/Outlook to learn your writing style for RAG.
    * However, it can use local CSV files as a fallback if live fetching fails or if you prefer static examples.
    * If you want to use this fallback, create/place:
        * `gmail_sent_emails.csv`
        * `outlook_desktop_sent_emails.csv`
    * These CSVs should have at least one column containing the body of your sent emails. Update the `CSV_BODY_COLUMN_NAME` variable in `app.py` if your column name is different (default is "Email Content").

## 7. Running the Application

1.  **Start Ollama:** Ensure your Ollama service is running and the model you specified in `app.py` is available.
2.  **Start the Backend Server (`app.py`):**
    * Open a terminal or command prompt.
    * Navigate to your project directory.
    * Activate your Python virtual environment (e.g., `venv\Scripts\activate` on Windows).
    * Run the Flask application:
        ```bash
        python app.py
        ```
    * The server will start, typically on `http://localhost:5000`.
    * **Important:** For Outlook functionality, this server **must be running on the Windows machine where Outlook Desktop is also running.**
    * Observe the console output for any errors during startup or operation.
3.  **Access the Frontend Web Interface:**
    * Navigate to the folder containing your frontend files (e.g., `unified_email_ui/`).
    * Open the `index.html` file in your preferred web browser.

## 8. Using the Application

1.  **Authentication Status:** The web page will show the connection status for Gmail and Outlook.
    * If Gmail shows "Not Connected", click the "Connect Gmail" button. This triggers an authentication process on the backend (a browser window might open on the machine running `app.py` if `token_gmail.json` is missing or invalid). After completion, you might need to refresh the auth status on the web page or refresh the page itself.
    * Outlook status depends on the backend successfully connecting to the local Outlook application.
2.  **Fetching Emails:** Click "Refresh All Inboxes" to load emails from connected accounts.
3.  **Drafting a Reply:**
    * Click the "Draft Reply" button next to an email in the list.
    * A modal popup will appear.
    * The system will fetch details of the original email and display them.
    * It will then contact Ollama (via the backend) to generate an AI draft based on the email content and your writing style (from your live sent items of that platform, or CSV fallback).
    * The AI draft will appear in an editable textarea.
4.  **Editing and Sending:**
    * You can edit the "To", "Subject", and "Body" fields in the modal.
    * Click "Regenerate Draft" to get a new AI draft if needed.
    * Click "Send Reply" to send the email using the original platform (Gmail or Outlook Desktop).
5.  **Status Messages:** The UI will display status messages for various operations (loading, success, errors). Check the browser's developer console (F12) and the Flask server console for more detailed logs if issues occur.

## 9. Key Configuration Variables (in `app.py`)

* `OLLAMA_MODEL`: The name of the Ollama model to use (e.g., "deepseek-r1:14b", "llama3").
* `USER_NAME`: Your name, used in prompts to the LLM (e.g., "Khurram").
* `GMAIL_CREDENTIALS_FILE`, `GMAIL_TOKEN_FILE`: Paths to Gmail API credential files.
* `USER_SENT_GMAIL_CSV`, `USER_SENT_OUTLOOK_CSV`, `CSV_BODY_COLUMN_NAME`: For fallback RAG style examples.
* `NUM_STYLE_EXAMPLES`: How many sent items to fetch/use for style learning.

## 10. Troubleshooting Tips

* **Ollama Not Responding:** Ensure the Ollama service is running and the model specified in `app.py` is downloaded (`ollama list`). Check the `OLLAMA_API_URL` in `app.py`.
* **Gmail Errors (403 Forbidden, "Metadata scope doesn't allow format FULL", etc.):**
    * This usually means `token_gmail.json` does not have the correct permissions.
    * Delete `token_gmail.json`.
    * Ensure `GMAIL_SCOPES` in `generate_token_gmail.py` (and `app.py`) includes `https://www.googleapis.com/auth/gmail.readonly`, `https://www.googleapis.com/auth/gmail.send`, and `https://www.googleapis.com/auth/gmail.metadata`.
    * Re-run `python generate_token_gmail.py` and carefully grant all requested permissions in the browser.
* **Outlook "Not Connected" or COM Errors in Flask Console:**
    * Ensure Outlook Desktop is running on the same Windows machine as `app.py`.
    * The Flask app (`app.py`) is configured to run as `threaded=False` and `use_reloader=False` when on Windows to improve COM stability. This is important.
    * If you still see COM errors (like `pywintypes.com_error`), it might be due to Outlook being busy, modal dialogs open in Outlook, or deeper COM threading conflicts. Restarting Outlook and then `app.py` can sometimes help. Ensure no other script is heavily using Outlook COM at the same time.
* **File Not Found (Credentials, Tokens, CSVs):** Double-check paths in `app.py` and ensure files are in the correct locations relative to `app.py`. The script now tries to use `os.path.join(os.path.dirname(__file__), ...)` for files like `token_gmail.json` and `credentials_gmail.json` to make them relative to `app.py`'s location.
* **Check Consoles:** Always check both the Flask server console and your web browser's developer console (F12) for error messages.

---